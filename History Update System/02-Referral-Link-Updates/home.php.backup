<?php
/**
 * EPIC Hub Member Dashboard Home
 * Halaman utama member area dengan pembatasan akses berdasarkan level
 */

if (!defined('EPIC_INIT')) {
    die('Direct access not allowed');
}

// Initialize data
$user = $user ?? epic_current_user();
$access_level = $access_level ?? epic_get_member_access_level($user);
$stats = epic_get_member_stats($user);

/**
 * Helper function for relative time formatting
 */
if (!function_exists('epic_format_relative_time')) {
    function epic_format_relative_time($date) {
        $now = new DateTime();
        $target = new DateTime($date);
        $diff = $now->diff($target);
        
        if ($diff->days > 0) {
            return $diff->days . ' hari yang lalu';
        } elseif ($diff->h > 0) {
            return $diff->h . ' jam yang lalu';
        } elseif ($diff->i > 0) {
            return $diff->i . ' menit yang lalu';
        } else {
            return 'Baru saja';
        }
    }
}

// Get recent activities (dummy data for now)
$recent_activities = [
    [
        'type' => 'order',
        'title' => 'Pembelian Produk',
        'description' => 'Anda membeli produk Digital Marketing Course',
        'amount' => 299000,
        'time' => date('Y-m-d H:i:s', strtotime('-2 hours')),
        'icon' => 'shopping-cart',
        'status' => 'success'
    ],
    [
        'type' => 'commission',
        'title' => 'Komisi Diterima',
        'description' => 'Komisi dari referral John Doe',
        'amount' => 50000,
        'time' => date('Y-m-d H:i:s', strtotime('-1 day')),
        'icon' => 'dollar-sign',
        'status' => 'success'
    ],
    [
        'type' => 'referral',
        'title' => 'Referral Baru',
        'description' => 'Jane Smith bergabung melalui link Anda',
        'amount' => 0,
        'time' => date('Y-m-d H:i:s', strtotime('-3 days')),
        'icon' => 'user-plus',
        'status' => 'info'
    ]
];

// Include content
require_once __DIR__ . '/content/home-content.php';
?>

<style>
/* ===== MEMBER HOME DARK GOLD THEME ===== */

/* CSS Variables untuk kompatibilitas */
:root {
    --surface-2: var(--bg-2);
    --surface-3: var(--card);
    --surface-4: var(--bg);
    --ink-100: var(--tx);
    --ink-200: var(--tx-2);
    --ink-300: var(--tx-3);
    --ink-400: var(--tx-3);
    --ink-600: var(--border);
    --ink-700: var(--border);
    --ink-900: var(--bg);
    --spacing-1: var(--space-1);
    --spacing-2: var(--space-2);
    --spacing-3: var(--space-3);
    --spacing-4: var(--space-4);
    --spacing-5: var(--space-5);
    --spacing-6: var(--space-6);
    --spacing-8: var(--space-8);
    --spacing-12: var(--space-12);
    --gold-300: var(--gold);
    --gold-400: var(--gold-600);
    --gradient-gold: var(--gradient-gold);
    --gradient-gold-subtle: linear-gradient(135deg, rgba(216, 183, 74, 0.1) 0%, rgba(232, 204, 107, 0.05) 100%);
    --shadow-lg: var(--shadow-card);
    --shadow-md: var(--shadow-card);
    --transition-fast: var(--transition-fast);
    --transition-normal: var(--transition-normal);
    --success: #22C55E;
    --success-dark: #16A34A;
    --warning: #F59E0B;
    --warning-dark: #D97706;
    --danger: #EF4444;
    --danger-light: #FCA5A5;
    --success-light: #86EFAC;
    --warning-light: #FDE68A;
    --font-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    --radius-full: 9999px;
}

/* Welcome Section with Dark Gold Theme */
.welcome-section {
    background: linear-gradient(135deg, var(--surface-2) 0%, var(--surface-3) 100%);
    border: 1px solid var(--ink-700);
    color: var(--ink-100);
    padding: var(--spacing-8);
    border-radius: var(--radius-2xl);
    margin-bottom: var(--spacing-8);
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
}

.welcome-section::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 200px;
    height: 200px;
    background: var(--gradient-gold-subtle);
    border-radius: 50%;
    transform: translate(50%, -50%);
}

.welcome-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
}

.welcome-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--spacing-2);
    color: var(--gold-300);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.welcome-subtitle {
    font-size: var(--font-size-lg);
    opacity: 0.9;
    margin: 0;
    color: var(--ink-200);
}

.welcome-actions {
    flex-shrink: 0;
}

.upgrade-actions {
    display: flex;
    gap: var(--spacing-4);
    margin-top: var(--spacing-6);
}

/* Activity Items */
.activity-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    padding: var(--spacing-4);
    background: var(--surface-3);
    border: 1px solid var(--ink-700);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-3);
    transition: all var(--transition-fast);
}

.activity-item:hover {
    background: var(--surface-4);
    border-color: var(--gold-400);
    transform: translateX(2px);
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gradient-gold);
    color: var(--ink-900);
}

.activity-icon.success {
    background: linear-gradient(135deg, var(--success), var(--success-dark));
    color: white;
}

.activity-icon.warning {
    background: linear-gradient(135deg, var(--warning), var(--warning-dark));
    color: white;
}

.activity-content {
    flex: 1;
}

.activity-text {
    color: var(--ink-100);
    font-size: var(--font-size-sm);
    line-height: 1.5;
}

.activity-text strong {
    color: var(--gold-300);
    font-weight: var(--font-weight-semibold);
}

.activity-time {
    font-size: var(--font-size-xs);
    color: var(--ink-400);
    margin-top: var(--spacing-1);
}

.activity-amount {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--success);
    background: rgba(16, 185, 129, 0.1);
    padding: var(--spacing-2) var(--spacing-3);
    border-radius: var(--radius-md);
    border: 1px solid var(--success);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: var(--spacing-12) var(--spacing-6);
    color: var(--ink-300);
}

.empty-state-icon {
    width: 80px;
    height: 80px;
    background: var(--surface-3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--spacing-6);
    border: 2px solid var(--ink-600);
}

.empty-state-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--ink-200);
    margin-bottom: var(--spacing-2);
}

.empty-state-text {
    color: var(--ink-400);
    font-size: var(--font-size-sm);
    max-width: 300px;
    margin: 0 auto;
}

/* Status Badges */
.status-badge {
    display: inline-block;
    padding: var(--spacing-1) var(--spacing-3);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.status-completed {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success-light);
    border: 1px solid var(--success);
}

.status-pending {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning-light);
    border: 1px solid var(--warning);
}

.status-cancelled {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger-light);
    border: 1px solid var(--danger);
}

/* Copy to Clipboard */
.copy-btn {
    background: var(--surface-3);
    border: 1px solid var(--ink-600);
    color: var(--ink-300);
    padding: var(--spacing-2);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.copy-btn:hover {
    background: var(--gold-400);
    color: var(--ink-900);
    border-color: var(--gold-400);
}

/* Referral Link Section Styling */
.referral-link-section {
    background: linear-gradient(135deg, var(--surface-2) 0%, var(--surface-3) 100%);
    border: 1px solid var(--ink-700);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
    margin-top: var(--spacing-6);
    position: relative;
    overflow: hidden;
}

.referral-link-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-gold);
    opacity: 0.9;
}

.referral-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    margin-bottom: var(--spacing-5);
}

.referral-icon {
    width: 48px;
    height: 48px;
    background: var(--gradient-gold);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--ink-900);
    box-shadow: var(--shadow-md);
}

.referral-title h4 {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--gold-300);
    margin: 0 0 var(--spacing-1) 0;
}

.referral-title p {
    font-size: var(--font-size-sm);
    color: var(--ink-300);
    margin: 0;
}

.referral-link-container {
    background: var(--surface-4);
    border: 1px solid var(--ink-600);
    border-radius: var(--radius-lg);
    padding: var(--spacing-4);
}

.referral-link-input-group {
    display: flex;
    gap: var(--spacing-2);
    margin-bottom: var(--spacing-4);
}

.referral-link-input {
    flex: 1;
    background: var(--surface-2);
    border: 1px solid var(--ink-600);
    border-radius: var(--radius-md);
    padding: var(--spacing-3) var(--spacing-4);
    color: var(--ink-100);
    font-family: var(--font-mono);
    font-size: var(--font-size-sm);
    transition: all var(--transition-fast);
}

.referral-link-input:focus {
    outline: none;
    border-color: var(--gold-400);
    box-shadow: 0 0 0 3px rgba(207, 168, 78, 0.1);
}

.referral-copy-btn {
    background: var(--gradient-gold);
    border: none;
    border-radius: var(--radius-md);
    padding: var(--spacing-3) var(--spacing-4);
    color: var(--ink-900);
    font-weight: var(--font-weight-semibold);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    min-width: 80px;
    justify-content: center;
}

.referral-copy-btn:hover {
    background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.referral-copy-btn:active {
    transform: translateY(0);
}

.referral-copy-btn.copied {
    background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
    color: white;
}

.referral-stats {
    display: flex;
    gap: var(--spacing-6);
    flex-wrap: wrap;
}

.referral-stat-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-1);
}

.referral-stat-item .stat-label {
    font-size: var(--font-size-xs);
    color: var(--ink-400);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: var(--font-weight-medium);
}

.referral-stat-item .stat-value {
    font-size: var(--font-size-sm);
    color: var(--gold-300);
    font-weight: var(--font-weight-bold);
    font-family: var(--font-mono);
}

/* Copy Success Animation */
@keyframes copySuccess {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.referral-copy-btn.copied {
    animation: copySuccess 0.3s ease-in-out;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .welcome-content {
        flex-direction: column;
        text-align: center;
        gap: var(--spacing-6);
    }
    
    .welcome-title {
        font-size: var(--font-size-xl);
    }
    
    .welcome-subtitle {
        font-size: var(--font-size-base);
    }
    
    .upgrade-actions {
        flex-direction: column;
        width: 100%;
    }
    
    .upgrade-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .activity-item {
        flex-direction: column;
        text-align: center;
        gap: var(--spacing-3);
    }
}

@media (max-width: 480px) {
    .welcome-section {
        padding: var(--spacing-6);
    }
    
    .welcome-title {
        font-size: var(--font-size-lg);
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .activity-item {
        padding: var(--spacing-3);
    }
    
    /* Referral Section Mobile */
    .referral-link-section {
        padding: var(--spacing-4);
        margin-top: var(--spacing-4);
    }
    
    .referral-header {
        flex-direction: column;
        text-align: center;
        gap: var(--spacing-3);
    }
    
    .referral-link-input-group {
        flex-direction: column;
        gap: var(--spacing-3);
    }
    
    .referral-copy-btn {
        width: 100%;
        justify-content: center;
    }
    
    .referral-stats {
        flex-direction: column;
        gap: var(--spacing-3);
        text-align: center;
    }
}

/* EPIS Supervisor Information Styling */
.epis-supervisor-info {
    margin-top: var(--spacing-4);
    padding: var(--spacing-4);
    background: linear-gradient(135deg, var(--surface-3) 0%, var(--surface-2) 100%);
    border: 1px solid var(--ink-600);
    border-radius: var(--radius-lg);
    position: relative;
}

.epis-supervisor-info::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gradient-gold);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.epis-supervisor-info.no-supervisor::before {
    background: linear-gradient(90deg, var(--warning) 0%, var(--warning-dark) 100%);
}

.supervisor-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    margin-bottom: var(--spacing-2);
}

.supervisor-icon {
    width: 24px;
    height: 24px;
    background: var(--gradient-gold);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--ink-900);
}

.supervisor-icon.warning {
    background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
    color: white;
}

.supervisor-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--ink-200);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.supervisor-details {
    margin-left: 32px;
}

.supervisor-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--gold-300);
    margin-bottom: var(--spacing-1);
}

.no-supervisor .supervisor-name {
    color: var(--warning);
}

.supervisor-code {
    font-size: var(--font-size-sm);
    color: var(--ink-300);
    font-family: var(--font-mono);
    margin-bottom: var(--spacing-1);
}

.supervisor-territory {
    font-size: var(--font-size-sm);
    color: var(--ink-400);
    font-style: italic;
}

.supervisor-note {
    font-size: var(--font-size-sm);
    color: var(--warning-light);
    font-style: italic;
}

/* Mobile responsive for EPIS info */
@media (max-width: 768px) {
    .epis-supervisor-info {
        padding: var(--spacing-3);
        margin-top: var(--spacing-3);
    }
    
    .supervisor-details {
        margin-left: 28px;
    }
    
    .supervisor-name {
        font-size: var(--font-size-base);
    }
}
</style>

<script>
/**
 * Copy referral link to clipboard with enhanced UX
 */
function copyReferralLink() {
    const input = document.getElementById('referralLinkInput');
    const button = document.querySelector('.referral-copy-btn');
    const copyText = button.querySelector('.copy-text');
    const copyIcon = button.querySelector('[data-feather="copy"]');
    
    if (!input || !button) {
        showCopyError();
        return;
    }
    
    // Get the text to copy
    const textToCopy = input.value;
    
    if (!textToCopy) {
        showCopyError();
        return;
    }
    
    // Try modern clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                showCopySuccess(button, copyText, copyIcon);
            })
            .catch(() => {
                // Fallback to manual selection method
                fallbackCopy(input, button, copyText, copyIcon);
            });
    } else {
        // Fallback for older browsers or non-secure contexts
        fallbackCopy(input, button, copyText, copyIcon);
    }
}

/**
 * Fallback copy method using selection and execCommand
 */
function fallbackCopy(input, button, copyText, copyIcon) {
    try {
        // Focus and select the input
        input.focus();
        input.select();
        input.setSelectionRange(0, 99999); // For mobile devices
        
        // Try to copy using execCommand
        const successful = document.execCommand('copy');
        
        if (successful) {
            showCopySuccess(button, copyText, copyIcon);
        } else {
            // If execCommand fails, show manual copy instruction
            showManualCopyInstruction(input.value);
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showManualCopyInstruction(input.value);
    }
}

/**
 * Show manual copy instruction when all methods fail
 */
function showManualCopyInstruction(text) {
    // Create a temporary modal or alert for manual copy
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div style="
            background: var(--surface-2);
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            color: var(--ink-100);
        ">
            <h3 style="margin-bottom: 1rem; color: var(--gold-300);">Salin Link Manual</h3>
            <p style="margin-bottom: 1rem;">Silakan salin link berikut secara manual:</p>
            <div style="
                background: var(--surface-4);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                word-break: break-all;
                font-family: monospace;
                border: 1px solid var(--ink-600);
            ">${text}</div>
            <button onclick="this.parentElement.parentElement.remove()" style="
                background: var(--gradient-gold);
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                color: var(--ink-900);
                font-weight: bold;
                cursor: pointer;
            ">Tutup</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Auto remove after 10 seconds
    setTimeout(() => {
        if (modal.parentElement) {
            modal.remove();
        }
    }, 10000);
}

/**
 * Show copy success feedback
 */
function showCopySuccess(button, copyText, copyIcon) {
    // Add copied class for styling
    button.classList.add('copied');
    
    // Change text and icon
    copyText.textContent = 'Tersalin!';
    copyIcon.setAttribute('data-feather', 'check');
    
    // Refresh feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    
    // Show toast notification
    showToastNotification('Link referral berhasil disalin!', 'success');
    
    // Reset after 2 seconds
    setTimeout(() => {
        button.classList.remove('copied');
        copyText.textContent = 'Salin';
        copyIcon.setAttribute('data-feather', 'copy');
        
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }, 2000);
}

/**
 * Show copy error feedback
 */
function showCopyError() {
    // Try to get the link value for manual copy
    const input = document.getElementById('referralLinkInput');
    if (input && input.value) {
        showManualCopyInstruction(input.value);
    } else {
        showToastNotification('Gagal menyalin link. Silakan copy manual.', 'error');
    }
}

/**
 * Show toast notification
 */
function showToastNotification(message, type = 'info') {
    // Remove existing toast
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <div class="toast-icon">
                <i data-feather="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}" width="20" height="20"></i>
            </div>
            <div class="toast-message">${message}</div>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">
                <i data-feather="x" width="16" height="16"></i>
            </button>
        </div>
    `;
    
    // Add toast styles
    const toastStyles = `
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface-2);
            border: 1px solid var(--ink-600);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }
        
        .toast-success {
            border-left: 4px solid var(--success);
        }
        
        .toast-error {
            border-left: 4px solid var(--danger);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .toast-icon {
            color: var(--gold-400);
        }
        
        .toast-success .toast-icon {
            color: var(--success);
        }
        
        .toast-error .toast-icon {
            color: var(--danger);
        }
        
        .toast-message {
            flex: 1;
            color: var(--ink-100);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--ink-400);
            cursor: pointer;
            padding: var(--spacing-1);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }
        
        .toast-close:hover {
            background: var(--surface-3);
            color: var(--ink-200);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .toast-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
        }
    `;
    
    // Add styles if not already added
    if (!document.querySelector('#toast-styles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'toast-styles';
        styleSheet.textContent = toastStyles;
        document.head.appendChild(styleSheet);
    }
    
    // Add toast to page
    document.body.appendChild(toast);
    
    // Refresh feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideInRight 0.3s ease-out reverse';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Refresh feather icons for referral section
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>
